<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cloud.ecloud.oauthz.dao.IOauthAccessTokenDao">
  <sql id="Base_Column_List">
    id, access_token, oauth_code, app_key, user_id, user_name, tenant_id, tenant_code, 
    token_type, create_time, expire_seconds, refresh_token, refresh_token_expire_seconds, 
    has_been_refreshed, refresh_from
  </sql>
  <select id="selectByAccessTokenCode" parameterType="java.lang.String" resultType="com.cloud.ecloud.oauthz.entity.OauthAccessToken">
    select 
    <include refid="Base_Column_List" />
    from oauth_access_token
    where access_token = #{access_token,jdbcType=VARCHAR}
  </select>

  <select id="getLastTokenByAppKey" parameterType="string" resultType="OauthAccessToken">
    SELECT * FROM oauth_access_token
    WHERE app_key = #{arg0}
    ORDER BY create_time DESC
    limit 0,1
  </select>

  <select id="selectByRefreshToken" parameterType="string" resultType="OauthAccessToken">
    SELECT * FROM oauth_access_token
    WHERE refresh_token = #{arg0}
    limit 0,1
  </select>

  <update id="handleExpiredToken" parameterType="timestamp">
    INSERT INTO oauth_access_token_history
    SELECT * FROM oauth_access_token
    WHERE (create_time + expires_in) &lt; #{arg0};
    DELETE FROM oauth_access_token
    WHERE (create_time + expires_in) &lt; #{arg0};
  </update>
</mapper>